<!--_meta 作为公共模版分离出去-->
{include file="_meta" /}
<!--/meta 作为公共模版分离出去-->
<title>单品管理</title>
</head>
<body>
<!--_header 作为公共模版分离出去-->
{include file="_header" /}
<!--/_header 作为公共模版分离出去-->

<!--_menu 作为公共模版分离出去-->
{include file="_menu" /}
<!--/_menu 作为公共模版分离出去--><section class="Hui-article-box">
    <nav class="breadcrumb"><i class="Hui-iconfont">&#xe67f;</i> <a href="{:url('index/index')}">首页</a>
        <span class="c-gray en">&gt;</span>
        产品管理
        <span class="c-gray en">&gt;</span>
        商品列表 <a class="btn btn-success radius r" style="line-height:1.6em;margin-top:3px" href="javascript:location.replace(location.href);" title="刷新" ><i class="Hui-iconfont">&#xe68f;</i></a> </nav>
    <div class="Hui-article">
        <article class="cl pd-20">
            <div class="text-c"> 日期范围：
                <input type="text"  id="logmin" class="input-text Wdate" style="width:120px;">
                -
                <input type="text"  id="logmax" class="input-text Wdate" style="width:120px;">
                <input type="text" name="" id="" placeholder=" 产品名称" style="width:250px" class="input-text">
                <button name="" id="" class="btn btn-success" type="submit"><i class="Hui-iconfont">&#xe665;</i> 搜产品</button>
            </div>
            <div class="cl pd-5 bg-1 bk-gray mt-20">
                <span class="l"> <a href="javascript:;" onclick="datadel()" class="btn btn-danger radius"><i class="Hui-iconfont">&#xe6e2;</i> 批量删除</a>
                    <a href="javascript:;" onClick="modaldemo()" class="btn btn-primary radius radius "><i class="Hui-iconfont">&#xe600;</i> 添加单品</a> </span>
                <span class="r">共有数据：<strong id="count"></strong> 条</span>
            </div>
            <table class="table table-border table-bordered table-bg">
                <thead>
                <tr>
                    <th scope="col" colspan="10">商品列表</th>
                    <input type="hidden" id="__token__" value="{$Request.token}" />
                </tr>
                <tr class="text-c">
                    <th width="40"><input name="" type="checkbox" value=""></th>
                    <th width="40">ID</th>
                    <th width="100">货号</th>
                    <th width="100">商品名称</th>
                    <th width="100">单价</th>
                    <th width="100">库存</th>
                    <th width="100">参数</th>
                    <th width="60">发布状态</th>
                    <th width="100">操作</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </article>
    </div>
</section>

<div id="modal-demo" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content radius" style="width: 650px">
            <div class="modal-header">
                <h3 class="modal-title">添加单品</h3>
                <a class="close" data-dismiss="modal" aria-hidden="true" href="javascript:void();">×</a>
            </div>
            <div class="modal-body">
                <article class="cl pd-20">
                    <form  class="form form-horizontal">
                        <div class="row cl">
                            <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>货品名称：</label>
                            <div class="formControls col-xs-8 col-sm-9">
                                <input type="text" class="input-text" value="" placeholder="请输入货品名称" id="goods_name" >
                            </div>
                        </div>
                        <div class="row cl">
                            <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>货品单价：</label>
                            <div class="formControls col-xs-8 col-sm-9">
                                <input type="text" class="input-text" value="" placeholder="请输入产品单价" oninput = "value=value.replace(/[^\d]/g,'')" maxlength="11" id="goods_price" >
                            </div>
                        </div>
                        <div class="row cl">
                            <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>货品库存：</label>
                            <div class="formControls col-xs-8 col-sm-9">
                                <input  type="text" class="input-text" value="" placeholder="请输入货品库存" oninput = "value=value.replace(/[^\d]/g,'')" maxlength="11" id="goods_num" >
                            </div>
                        </div>
                        <br>
                        <div style="margin-left: 40px">
                            <span>请选择属性：</span>
                        </div>
<!--                        <div  style="height: 20px"></div>-->
<!--                        <div style="margin-left: 150px" id="my_div">-->

<!--                        </div>-->
                        <span id="my_div"></span>
                    </form>
                </article>
            </div>
            <div class="modal-footer">
                <button id="add_onegoods"  class="btn btn-primary">添加</button>
                <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
            </div>
        </div>
    </div>
</div>

<div id="update-demo" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content radius" style="width: 650px">
            <div class="modal-header">
                <h3 class="modal-title">修改信息</h3>
                <a class="close" data-dismiss="modal" aria-hidden="true" href="javascript:void();">×</a>
            </div>
            <div class="modal-body">
                <article class="cl pd-20">
                    <form  class="form form-horizontal">
                        <div class="row cl">
                            <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>货品名称：</label>
                            <div class="formControls col-xs-8 col-sm-9">
                                <input type="text" class="input-text" value="" placeholder="请输入货品名称" id="up_name" >
                            </div>
                        </div>
                        <div class="row cl">
                            <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>货品单价：</label>
                            <div class="formControls col-xs-8 col-sm-9">
                                <input type="text" class="input-text" value="" placeholder="请输入产品单价" oninput = "value=value.replace(/[^\d]/g,'')" maxlength="11" id="up_price" >
                            </div>
                        </div>
                        <div class="row cl">
                            <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>货品库存：</label>
                            <div class="formControls col-xs-8 col-sm-9">
                                <input  type="text" class="input-text" value="" placeholder="请输入货品库存" oninput = "value=value.replace(/[^\d]/g,'')" maxlength="11" id="up_stock" >
                            </div>
                        </div>
                        <br>
                        <div style="margin-left: 40px">
                            <span>请选择属性：</span>
                        </div>
                        <!--                        <div  style="height: 20px"></div>-->
                        <!--                        <div style="margin-left: 150px" id="my_div">-->

                        <!--                        </div>-->
                        <span id="up_div"></span>
                        <span id="up_id"></span>
                    </form>
                </article>
            </div>
            <div class="modal-footer">
                <button id="update_onegoods"  class="btn btn-primary">修改dd</button>
                <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
            </div>
        </div>
    </div>
</div>
<!--_footer 作为公共模版分离出去-->
{include file="_footer" /}
<!--/_footer /作为公共模版分离出去-->

<!--请在下方写此页面业务相关的脚本-->
<script type="text/javascript" src="__ADMIN__/lib/My97DatePicker/4.8/WdatePicker.js"></script>
<script type="text/javascript" src="__ADMIN__/lib/datatables/1.10.0/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="__ADMIN__/lib/laypage/1.2/laypage.js"></script>
<script type="text/javascript" src="__ADMIN__/lib/zTree/v3/js/jquery.ztree.all-3.5.min.js"></script>
<script type="text/javascript">
    function modaldemo(){
        $("#modal-demo").modal("show")
    }

    // function show() {//之前根据id串查的属性，太慢了，改进了一下，直接存了属性值的name
    //     var goods_id = '{$goods_id}'
    //     $.get("{:url('onegoods/show')}",{goods_id:goods_id},function (res) {
    //         var tr = ''
    //         $('#count').html(res.count)
    //         var data = res.data
    //         $.each(data,function (kk,vv) {
    //             tr += "<tr class='text-c va-m'>";
    //             $.each(vv,function (k,v) {
    //                 tr += "<td><input id='goods_dels' type='checkbox' value='"+v.id+"'></td>";
    //                 tr += "<td>"+v.id+"</td>";
    //                 tr += "<td>"+v.sn_number+"</td>";
    //                 tr += "<td>"+v.name+"</td>";
    //                 tr += "<td><span class='price'>"+v.price+"</span></td>";
    //                 tr += "<td>"+v.attr+"</td>";
    //                 tr += "<td class='td-status'><span class='label label-success radius'>已发布</span></td>";
    //                 tr += "<td class='td-manage'>";
    //                 tr += "<a style='text-decoration:none' onClick=product_stop(this,'10001') href='javascript:;' title='下架'>";
    //                 tr += "<i class='Hui-iconfont'>&#xe6de;</i></a>";
    //                 tr += "<a style='text-decoration:none' class='ml-5' onClick=update_goods('"+v.id+"','"+v.brand_id+"','"+v.category_id+"','"+v.goods_unit_id+"','"+v.goods_name+"','"+v.goods_price+"') href='javascript:;' title='编辑'>";
    //                 tr += "<i class='Hui-iconfont'>&#xe6df;</i></a>";
    //                 tr += "  <a style='text-decoration:none' class='ml-5' onClick=goods_del(this,'"+v.id+"') href='javascript:;' title='删除'>";
    //                 tr += "<i class='Hui-iconfont'>&#xe6e2;</i></a></td>";
    //             })
    //             tr += "</tr>"
    //         })
    //         $('.table tbody').html(tr)
    //     },'json')
    // }
    //之前根据id串查的属性，太慢了，改进了一下，直接存了属性值的name
    function show() {
        $.post("{:url('onegoods/show')}",{goods_id:'{$goods_id}'},function (res) {
            var tr = ''
            $('#count').html(res.count)
            var data = res.data
            $.each(data,function (k,v) {
                tr += "<tr class='text-c va-m'>";
                tr += "<td><input id='goods_dels' type='checkbox' value='"+v.id+"'></td>";
                tr += "<td>"+v.id+"</td>";
                tr += "<td>"+v.sn_number+"</td>";
                tr += "<td>"+v.name+"</td>";
                tr += "<td><span class='price'>"+v.price+"</span></td>";
                tr += "<td>"+v.stock+"</td>";
                tr += "<td>"+v.attr_name+"</td>";
                tr += "<td class='td-status'><span class='label label-success radius'>已发布</span></td>";
                tr += "<td class='td-manage'>";
                tr += "<a style='text-decoration:none' onClick=product_stop(this,'10001') href='javascript:;' title='下架'>";
                tr += "<i class='Hui-iconfont'>&#xe6de;</i></a>";
                //点击事件里面加一个转义符,是因为name里面有空格，不然会报错
                tr += "<a style='text-decoration:none' class='ml-5' onClick=\" update_goods("+v.id+",' "+ v.name +" ','"+v.price+"','"+v.stock+"','"+v.goods_attr_id+"')\" href='javascript:;' title='编辑'>";
                tr += "<i class='Hui-iconfont'>&#xe6df;</i></a>";
                tr += "  <a style='text-decoration:none' class='ml-5' onClick=goods_del(this,'"+v.id+"') href='javascript:;' title='删除'>";
                tr += "<i class='Hui-iconfont'>&#xe6e2;</i></a></td>";
                tr += "</tr>"
            })
            $('.table tbody').html(tr)
        },'json')
    }
    show()
    $('#update_onegoods').click(function () {
        var attr_id = []
        //查找获取容器里面的select，下面进行遍历
        var ids = $("#up_div").find('select')
        var attr_name = new Array();
        //获取一切值的神器map，获取容器里面下拉框的默认值，value和text
        $("#up_div  option:selected").map(function(){
            if ($(this).val() !=0) {
                attr_name.push($(this).text());
                attr_id.push($(this).val());
            }
        })
        var __token__ = $('#__token__').val()
        var name = $('#up_name').val()
        var id = $('#up_id').html()
        var price = $('#up_price').val()
        var stock = $('#up_stock').val()
        console.log(stock)
        //获取下拉框默认值
        if (name == '' || price == '' || stock == '' || attr_id == '') {
            $.Huimodalalert('商品名、库存、单价、属性不能为空', 1000)
            return false
        }
        $.ajax({
            url: "{:url('onegoods/update')}",
            data:{
                id:id,
                attr_id:attr_id,
                attr_name:attr_name,
                goods_id:"{$goods_id}",
                name: name,
                price: price,
                stock: stock,
                __token__: __token__
            },
            type:'post',
            dataType:'json',
            success: function (res) {
                token()
                if (res.status == 'error') {
                    $.Huimodalalert(res.message, 1000)
                }
                if (res.code == '10001') {
                    layer.msg('修改成功', {icon: 1, time: 1000});
                    $("#update-demo").modal("hide")
                    show()
                }
            }
        })
    })
    //修改商品，获取默认值
    function update_goods(id,name,price,stock,goods_attr_id){
        $('#up_name').val(name)//商品品牌的默认值
        $('#up_stock').val(stock)//商品单位的默认值
        $('#up_id').html(id)//商品id
        $('#up_price').val(price)//商品单价的默认值
        //把字符字符串转换成数组，以逗号为准
        $('#my_upid').html(goods_attr_id)
        var str = goods_attr_id.split(/,/);
        $("#update-demo").modal("show")
        var goods_id = '{$goods_id}'
        $.post( "{:url('onegoods/attrshow')}", {goods_id:goods_id}, function (res) {
            var div = ""
            $.each(res.data,function (k,v) {
                div += "<div class='row cl' >"
                div += "<label class='form-label col-xs-4 col-sm-3'>"+k+"：</label>"
                div += "<div  class='formControls col-xs-8 col-sm-9 '>"
                div += "<span id='up_select' class='select-box'>"
                div += "<select   class='select'>"
                div += "<option value='0' style='color: grey'>- - "+k+" - -</option>"
                $.each(v,function (k1,v1) {
                    if (isInArray(str,v1.attr_details_id)==v1.attr_details_id) {
                        div += "<option value='" + v1.attr_details_id + "'  id = 'attr" + v1.attr_details_id + "' selected>" + v1.ad_name + "</option>"
                    }
                    else {
                        div += "<option value='" + v1.attr_details_id + "'  id = 'attr" + v1.attr_details_id + "' >" + v1.ad_name + "</option>"
                    }
                })
                div += "</select>"
                // div += "<div style='height: 20px'></div>"
                div += "</span>"
                div += "</div>"
                div += "</div>"
            })
            $('#up_div').html(div)
        },'json')
    }
    //封装判断字符串是否存在数组里并返回值
    function isInArray(arr,value){
        for(var i = 0; i < arr.length; i++){
            if(value == arr[i]){
                return value;
            }
        }
        return false;
    }
    function attrshow(){
        var goods_id = '{$goods_id}'
        $.post( "{:url('onegoods/attrshow')}", {goods_id:goods_id}, function (res) {
            var div = ""
            $.each(res.data,function (k,v) {
                div += "<div class='row cl' >"
                div += "<label class='form-label col-xs-4 col-sm-3'>"+k+"：</label>"
                div += "<div  class='formControls col-xs-8 col-sm-9 '>"
                div += "<span id='my_select' class='select-box'>"
                div += "<select class='select' name='country'>"
                div += "<option value='0' style='color: grey'>- - "+k+" - -</option>"
                $.each(v,function (k1,v1) {
                    div+="<option value='"+v1.attr_details_id+"'  attr_name = '"+v1.ad_name+"'>"+v1.ad_name+"</option>"
                })
                div += "</select>"
                // div += "<div style='height: 20px'></div>"
                div += "</span>"
                div += "</div>"
                div += "</div>"
            })
            $('#my_div').html(div)
        },'json')
    }
    attrshow()
    //添加货品
    $('#add_onegoods').click(function () {
        var attr_id = []
        //查找获取容器里面的select，下面进行遍历
        var ids = $("#my_div").find('select')
        var attr_name = new Array();
        //获取一切值的神器map，获取容器里面下拉框的默认值，value和text
        $("#my_div  option:selected").map(function(){
            if ($(this).val() !=0) {
                attr_name.push($(this).text());
                attr_id.push($(this).val());
            }
        })
        //循环select框，获取它的默认值，不等于0就放到数组里面
        // $(ids).each(function (k,v) {
        //     console.log(v)
        //     // console.log(v.innerTEXT)
        //     if (v.value != 0) {
        //         attr_id.push(v.value)
        //     }
        // })
        //获取div里下面的select框的默认值，和上面方法一样的效果
        // var id = []
        // $("#my_select").children("select").each(function (k,v) {
        //
        //     for (var i = 0; i < v.length; i++){
        //         //如果下拉框里面有默认值，另外值部等于0,就把它放到数组里面
        //         if (v.options[i].selected){
        //             id.push(v[i].value)
        //         }
        //     }
        // })
        // console.log(id)
        var __token__ = $('#__token__').val()
        var goods_name = $('#goods_name').val()
        var goods_price = $('#goods_price').val()
        var stock = $('#goods_num').val()
        //获取下拉框默认值
        if (goods_name == '' || goods_price == '' || goods_num == '' || attr_id == '') {
            $.Huimodalalert('商品名、库存、单价、属性不能为空', 1000)
            return false
        }
        $.ajax({
            url: "{:url('onegoods/add')}",
            data:{
                attr_id:attr_id,
                attr_name:attr_name,
                goods_id:"{$goods_id}",
                name: goods_name,
                price: goods_price,
                stock: stock,
                __token__: __token__
            },
            type:'post',
            dataType:'json',
            success: function (res) {
                token()
                if (res.status == 'error') {
                    $.Huimodalalert(res.message, 1000)
                }
                if (res.code == '10001') {
                    layer.msg('添加成功', {icon: 1, time: 1000});
                    $("#modal-demo").modal("hide")
                    show()
                }
            }
        })
    })
    function goods_del(obj,id){
        layer.confirm('角色删除须谨慎，确认要删除吗？',function(index){
            //此处请求后台程序，下方是成功后的前台处理……
            var __token__=$('#__token__').val()
            $.post("{:url('onegoods/delete')}", {id:id,__token__:__token__}, function (res) {
                token()
                if (res.status=='error'){
                    $.Huimodalalert(res.message,1000)
                    layer.msg('!',{icon:1,time:1});
                }
                if (res.code=='10001'){
                    $(obj).parents("tr").remove();
                    layer.msg('已删除!',{icon:1,time:1000});
                }
            },'json')
        });
    }
    //批量删除
    function datadel() {
        var __token__=$('#__token__').val()
        var ids=$('#goods_dels:checked')
        //判断checdbox是否有被选中的，选中返回true,没选返回true

        var checked_id = $('#goods_dels:checked').is(':checked')
        //如果有被选中的就提示是否要删除
        if (checked_id == true) {
            layer.confirm('角色删除须谨慎，确认要删除吗？', function (index) {
                var id=[]
                $.each(ids, function (k, v) {
                    //把值放到数组里面
                    id.push(v.value)
                })
                traditional:true,//ajax传数组到后台需要用到
                    $.post("{:url('onegoods/delete')}", {id:id,__token__:__token__}, function (res) {
                        token()
                        if (res.status=='error'){
                            $.Huimodalalert(res.message,1000)
                            layer.msg('!',{icon:1,time:1});
                        }
                        if (res.code=='10001'){
                            $('#role_dels:checked').parents("tr").remove();
                            layer.msg('已删除!',{icon:1,time:1000});
                            show()
                        }
                    },'json')
            });
        }
    }
    function product_shenhe(obj,id){
        layer.confirm('审核文章？', {
                btn: ['通过','不通过'],
                shade: false
            },
            function(){
                $(obj).parents("tr").find(".td-manage").prepend('<a class="c-primary" onClick="product_start(this,id)" href="javascript:;" title="申请上线">申请上线</a>');
                $(obj).parents("tr").find(".td-status").html('<span class="label label-success radius">已发布</span>');
                $(obj).remove();
                layer.msg('已发布', {icon:6,time:1000});
            },
            function(){
                $(obj).parents("tr").find(".td-manage").prepend('<a class="c-primary" onClick="product_shenqing(this,id)" href="javascript:;" title="申请上线">申请上线</a>');
                $(obj).parents("tr").find(".td-status").html('<span class="label label-danger radius">未通过</span>');
                $(obj).remove();
                layer.msg('未通过', {icon:5,time:1000});
            });
    }
    /*图片-下架*/
    function product_stop(obj,id){
        layer.confirm('确认要下架吗？',function(index){
            $(obj).parents("tr").find(".td-manage").prepend('<a style="text-decoration:none" onClick="product_start(this,id)" href="javascript:;" title="发布"><i class="Hui-iconfont">&#xe603;</i></a>');
            $(obj).parents("tr").find(".td-status").html('<span class="label label-defaunt radius">已下架</span>');
            $(obj).remove();
            layer.msg('已下架!',{icon: 5,time:1000});
        });
    }

    /*图片-发布*/
    function product_start(obj,id){
        layer.confirm('确认要发布吗？',function(index){
            $(obj).parents("tr").find(".td-manage").prepend('<a style="text-decoration:none" onClick="product_stop(this,id)" href="javascript:;" title="下架"><i class="Hui-iconfont">&#xe6de;</i></a>');
            $(obj).parents("tr").find(".td-status").html('<span class="label label-success radius">已发布</span>');
            $(obj).remove();
            layer.msg('已发布!',{icon: 6,time:1000});
        });
    }
    /*图片-申请上线*/
    function product_shenqing(obj,id){
        $(obj).parents("tr").find(".td-status").html('<span class="label label-default radius">待审核</span>');
        $(obj).parents("tr").find(".td-manage").html("");
        layer.msg('已提交申请，耐心等待审核!', {icon: 1,time:2000});
    }
    /*图片-编辑*/
    function product_edit(title,url,id){
        var index = layer.open({
            type: 2,
            title: title,
            content: url
        });
        layer.full(index);
    }
    /*图片-删除*/
    function product_del(obj,id){
        layer.confirm('确认要删除吗？',function(index){
            $(obj).parents("tr").remove();
            layer.msg('已删除!',{icon:1,time:1000});
        });
    }
</script>
<!--/请在上方写此页面业务相关的脚本-->
</body>
</html>